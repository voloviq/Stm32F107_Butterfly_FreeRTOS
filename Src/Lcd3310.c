#include "stm32f10x_lib.h"
#include "Lcd3310.h"





unsigned char cursor_row = 0; /* 0-6 */
unsigned char cursor_col = 0; /* 0-83 */
unsigned char lcd_buffer[8][84];





// Font definition 24x40
static const char number[11][5][24]  = {

{{
0x00 , 0x00 , 0xC0 , 0xF0 , 0xF8 , 0xFC , 0xFE , 0x7E,
0x3F , 0x1F , 0x1F , 0x1F , 0x1F , 0x3F , 0x7F , 0xFE,
0xFC , 0xF8 , 0xE0 , 0xC0 , 0x00 , 0x00 , 0x00 , 0x00
},{
0xE0 , 0xFF , 0xFF , 0xFF , 0xFF , 0x1F , 0x01 , 0x00,
0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x01,
0x0F , 0xFF , 0xFF , 0xFF , 0xFF , 0xF8 , 0x00 , 0x00
},{
0xFF , 0xFF , 0xFF , 0xFF , 0xFF , 0x00 , 0x00 , 0x00,
0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00,
0x80 , 0xFF , 0xFF , 0xFF , 0xFF , 0x7F , 0x00 , 0x00
},{
0x00 , 0x3F , 0xFF , 0xFF , 0xFF , 0xFF , 0xF0 , 0x80,
0x80 , 0x00 , 0x00 , 0x00 , 0x80 , 0xC0 , 0xE0 , 0xF8,
0xFF , 0xFF , 0xFF , 0x3F , 0x0F , 0x00 , 0x00 , 0x00
},{
0x00 , 0x00 , 0x00 , 0x01 , 0x03 , 0x07 , 0x0F , 0x0F,
0x1F , 0x1F , 0x1F , 0x1F , 0x0F , 0x0F , 0x0F , 0x07,
0x03 , 0x01 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00
}},

//1
{{
0xC0 , 0xE0 , 0xE0 , 0xF0 , 0xF8 , 0xFC , 0xFE , 0xFE,
0xFF , 0xFF , 0xFF , 0x00 , 0x00 , 0x00 , 0x00 , 0x00,
0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00
},{
0x01 , 0x03 , 0x03 , 0x03 , 0x01 , 0x00 , 0xFF , 0xFF,
0xFF , 0xFF , 0xFF , 0x00 , 0x00 , 0x00 , 0x00 , 0x00,
0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00
},{
0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0xFE , 0xFF , 0xFF,
0xFF , 0xFF , 0x01 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00,
0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00
},{
0x00 , 0x80 , 0x80 , 0x80 , 0x80 , 0xFF , 0xFF , 0xFF,
0xFF , 0xFF , 0x80 , 0x80 , 0x80 , 0x80 , 0x00 , 0x00,
0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00
},{
0x07 , 0x0F , 0x0F , 0x0F , 0x0F , 0x0F , 0x0F , 0x0F,
0x0F , 0x0F , 0x0F , 0x0F , 0x0F , 0x0F , 0x07 , 0x00,
0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00
}},

//2
{{
0xC0 , 0xE0 , 0xF0 , 0xF8 , 0xFC , 0xFC , 0x7E , 0x3E,
0x3F , 0x1F , 0x1F , 0x1F , 0x1F , 0x3F , 0x3F , 0x7E,
0xFE , 0xFC , 0xF8 , 0xF0 , 0xE0 , 0x00 , 0x00 , 0x00
},{
0x01 , 0x03 , 0x03 , 0x01 , 0x01 , 0x00 , 0x00 , 0x00,
0x00 , 0x00 , 0x00 , 0x00 , 0x80 , 0xC0 , 0xE0 , 0xF8,
0xFF , 0xFF , 0xFF , 0x3F , 0x0F , 0x00 , 0x00 , 0x00
},{
0x00 , 0x00 , 0x80 , 0xC0 , 0xE0 , 0xE0 , 0xF0 , 0xF8,
0xFC , 0x7C , 0x3E , 0x1F , 0x1F , 0x0F , 0x07 , 0x07,
0x03 , 0x01 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00
},{
0xF8 , 0xFE , 0xFF , 0xFF , 0xFF , 0x8F , 0x83 , 0x80,
0x80 , 0xC0 , 0xC0 , 0xC0 , 0xC0 , 0xC0 , 0xC0 , 0xC0,
0xC0 , 0xC0 , 0xC0 , 0x80 , 0x00 , 0x00 , 0x00 , 0x00
},{
0x07 , 0x0F , 0x0F , 0x0F , 0x0F , 0x0F , 0x0F , 0x07,
0x07 , 0x07 , 0x07 , 0x07 , 0x07 , 0x07 , 0x07 , 0x07,
0x07 , 0x0F , 0x0F , 0x0F , 0x07 , 0x00 , 0x00 , 0x00
}},

//3
{{
0x70 , 0xF8 , 0xFC , 0x7C , 0x7E , 0x3E , 0x3F , 0x1F,
0x1F , 0x1F , 0x1F , 0x1F , 0x3F , 0x3E , 0x7E , 0xFE,
0xFC , 0xF8 , 0xF0 , 0xC0 , 0x00 , 0x00 , 0x00 , 0x00
},{
0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x80 , 0x80 , 0xC0,
0xC0 , 0xC0 , 0xC0 , 0xE0 , 0xE0 , 0xF0 , 0xF8 , 0xFF,
0xFF , 0x7F , 0x3F , 0x0F , 0x00 , 0x00 , 0x00 , 0x00
},{
0x00 , 0x00 , 0x00 , 0x00 , 0x03 , 0x07 , 0x07 , 0x07,
0x07 , 0x07 , 0x0F , 0x0F , 0x0F , 0x1F , 0x3F , 0xFE,
0xFE , 0xFC , 0xF8 , 0xF0 , 0xC0 , 0x00 , 0x00 , 0x00
},{
0xF8 , 0xF8 , 0xF8 , 0xE0 , 0xC0 , 0x80 , 0x00 , 0x00,
0x00 , 0x00 , 0x00 , 0x00 , 0x80 , 0x80 , 0xC0 , 0xE0,
0xFF , 0xFF , 0xFF , 0x7F , 0x1F , 0x00 , 0x00 , 0x00
},{
0x01 , 0x03 , 0x07 , 0x07 , 0x0F , 0x0F , 0x1F , 0x1F,
0x1F , 0x1F , 0x1F , 0x1F , 0x1F , 0x0F , 0x0F , 0x07,
0x07 , 0x03 , 0x01 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00
}},

//4
{{
0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00,
0x00 , 0x00 , 0xC0 , 0xE0 , 0xF8 , 0xFC , 0x7E , 0xFF,
0xFF , 0xFF , 0xFF , 0xFE , 0x00 , 0x00 , 0x00 , 0x00
},{
0x00 , 0x00 , 0x00 , 0x00 , 0x80 , 0xE0 , 0xF0 , 0xFC,
0xFE , 0x7F , 0x3F , 0x0F , 0x07 , 0x01 , 0x00 , 0xFF,
0xFF , 0xFF , 0xFF , 0xFF , 0x00 , 0x00 , 0x00 , 0x00
},{
0xC0 , 0xF0 , 0xFC , 0xFF , 0xFF , 0xDF , 0xCF , 0xC3,
0xC1 , 0xC0 , 0xC0 , 0xC0 , 0xC0 , 0xC0 , 0xC0 , 0xFF,
0xFF , 0xFF , 0xFF , 0xFF , 0xC0 , 0xC0 , 0x80 , 0x00
},{
0x01 , 0x03 , 0x03 , 0x03 , 0x07 , 0x07 , 0x07 , 0x07,
0x07 , 0x07 , 0x07 , 0x07 , 0x07 , 0x07 , 0x07 , 0xFF,
0xFF , 0xFF , 0xFF , 0xFF , 0x07 , 0x07 , 0x03 , 0x00
},{
0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00,
0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x0F,
0x1F , 0x1F , 0x1F , 0x0F , 0x00 , 0x00 , 0x00 , 0x00
}},

//5
{{
0xFE , 0xFF , 0xFF , 0xFF , 0xFF , 0x1F , 0x1F , 0x1F,
0x1F , 0x1F , 0x1F , 0x1F , 0x1F , 0x1F , 0x1F , 0x1F,
0x1F , 0x1F , 0x1F , 0x0F , 0x0E , 0x00 , 0x00 , 0x00
},{
0xFF , 0xFF , 0xFF , 0xFF , 0xF1 , 0xF0 , 0xF8 , 0xF8,
0xFC , 0x7C , 0x7C , 0x7C , 0x7C , 0x7C , 0x7C , 0xFC,
0xF8 , 0xF8 , 0xF0 , 0xE0 , 0xC0 , 0x00 , 0x00 , 0x00
},{
0x07 , 0x0F , 0x0F , 0x0F , 0x07 , 0x03 , 0x01 , 0x00,
0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00,
0x01 , 0xFF , 0xFF , 0xFF , 0xFF , 0xFC , 0x00 , 0x00
},{
0xE0 , 0xF0 , 0xF0 , 0xC0 , 0x80 , 0x80 , 0x00 , 0x00,
0x00 , 0x00 , 0x00 , 0x00 , 0x80 , 0x80 , 0xC0 , 0xE0,
0xF0 , 0xFF , 0xFF , 0xFF , 0x7F , 0x07 , 0x00 , 0x00
},{
0x01 , 0x03 , 0x07 , 0x0F , 0x0F , 0x1F , 0x1F , 0x1F,
0x1F , 0x1F , 0x1F , 0x1F , 0x1F , 0x0F , 0x0F , 0x0F,
0x07 , 0x03 , 0x03 , 0x01 , 0x00 , 0x00 , 0x00 , 0x00
}},

//6
{{
0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0xC0 , 0xE0,
0xF0 , 0xF8 , 0xFC , 0xFE , 0x7E , 0x3F , 0x1F , 0x06,
0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00
},{
0x00 , 0x80 , 0xF0 , 0xFC , 0xFE , 0xFF , 0x7F , 0x9F,
0x87 , 0x83 , 0xC1 , 0xC0 , 0xC0 , 0xC0 , 0xC0 , 0xC0,
0x80 , 0x80 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00
},{
0xFC , 0xFF , 0xFF , 0xFF , 0xFF , 0x1F , 0x0F , 0x0F,
0x07 , 0x07 , 0x07 , 0x07 , 0x07 , 0x07 , 0x07 , 0x0F,
0x1F , 0x3F , 0xFF , 0xFF , 0xFE , 0xFC , 0xE0 , 0x00
},{
0x0F , 0x7F , 0xFF , 0xFF , 0xFF , 0xF8 , 0xE0 , 0x80,
0x80 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x80 , 0x80,
0xC0 , 0xF0 , 0xFF , 0xFF , 0xFF , 0x7F , 0x1F , 0x00
},{
0x00 , 0x00 , 0x01 , 0x03 , 0x07 , 0x0F , 0x0F , 0x1F,
0x1F , 0x1F , 0x1F , 0x1F , 0x1F , 0x1F , 0x1F , 0x0F,
0x0F , 0x07 , 0x07 , 0x03 , 0x01 , 0x00 , 0x00 , 0x00
}},

//7
{{
0x0E , 0x1F , 0x1F , 0x1F , 0x1F , 0x1F , 0x1F , 0x1F,
0x1F , 0x1F , 0x1F , 0x1F , 0x1F , 0x9F , 0xDF , 0xFF,
0xFF , 0xFF , 0xFF , 0x7F , 0x3F , 0x1F , 0x07 , 0x00
},{
0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00,
0x00 , 0xC0 , 0xF0 , 0xFC , 0xFE , 0xFF , 0x7F , 0x1F,
0x07 , 0x01 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00
},{
0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x80 , 0xE0 , 0xFC,
0xFF , 0xFF , 0x7F , 0x1F , 0x07 , 0x01 , 0x00 , 0x00,
0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00
},{
0x00 , 0x00 , 0x80 , 0xF0 , 0xFC , 0xFF , 0xFF , 0x7F,
0x0F , 0x03 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00,
0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00
},{
0x00 , 0x0E , 0x1F , 0x1F , 0x1F , 0x0F , 0x01 , 0x00,
0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00,
0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00
}},

//8
{{
0x80 , 0xE0 , 0xF0 , 0xF8 , 0xFC , 0xFE , 0x3E , 0x3E,
0x1F , 0x1F , 0x1F , 0x1F , 0x1F , 0x1F , 0x1F , 0x3F,
0x7E , 0xFE , 0xFC , 0xFC , 0xF0 , 0xC0 , 0x00 , 0x00
},{
0x1F , 0x7F , 0xFF , 0xFF , 0xFF , 0xF0 , 0xF0 , 0xE0,
0xE0 , 0xC0 , 0xC0 , 0xC0 , 0xC0 , 0xE0 , 0xE0 , 0xF0,
0xF8 , 0xFF , 0x7F , 0x7F , 0x3F , 0x0F , 0x00 , 0x00
},{
0xC0 , 0xF8 , 0xFC , 0xFF , 0xFF , 0x3F , 0x1F , 0x1F,
0x0F , 0x0F , 0x07 , 0x07 , 0x0F , 0x0F , 0x0F , 0x1F,
0x3F , 0xFF , 0xFE , 0xFC , 0xF0 , 0xC0 , 0x00 , 0x00
},{
0xFF , 0xFF , 0xFF , 0xFF , 0xE0 , 0xC0 , 0x80 , 0x80,
0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x80,
0xE0 , 0xFF , 0xFF , 0xFF , 0xFF , 0x3F , 0x00 , 0x00
},{
0x00 , 0x03 , 0x07 , 0x07 , 0x0F , 0x0F , 0x1F , 0x1F,
0x1F , 0x1F , 0x1F , 0x1F , 0x1F , 0x1F , 0x1F , 0x0F,
0x0F , 0x0F , 0x07 , 0x03 , 0x01 , 0x00 , 0x00 , 0x00
}},

//9
{{
0xC0 , 0xF8 , 0xFC , 0xFE , 0xFE , 0x3F , 0x1F , 0x1F,
0x0F , 0x0F , 0x0F , 0x0F , 0x1F , 0x1F , 0x1F , 0x3F,
0xFE , 0xFE , 0xFC , 0xF8 , 0xF0 , 0x80 , 0x00 , 0x00
},{
0xFF , 0xFF , 0xFF , 0xFF , 0xC0 , 0x00 , 0x00 , 0x00,
0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00,
0x00 , 0xFF , 0xFF , 0xFF , 0xFF , 0xFF , 0x00 , 0x00
},{
0x01 , 0x07 , 0x0F , 0x1F , 0x3F , 0x3F , 0x3E , 0x7E,
0x7C , 0x7C , 0x7C , 0x7C , 0x7C , 0x3C , 0x3E , 0x9F,
0xFF , 0xFF , 0xFF , 0xFF , 0xFF , 0x07 , 0x00 , 0x00
},{
0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x80,
0x80 , 0xC0 , 0xE0 , 0xE0 , 0xF0 , 0xF8 , 0xFE , 0x7F,
0x3F , 0x1F , 0x0F , 0x03 , 0x00 , 0x00 , 0x00 , 0x00
},{
0x00 , 0x00 , 0x0E , 0x1E , 0x1F , 0x1F , 0x0F , 0x0F,
0x0F , 0x07 , 0x07 , 0x03 , 0x01 , 0x01 , 0x00 , 0x00,
0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00
}},

//oC
{{
0x38 , 0x7C , 0xEE , 0xC7 , 0xC7 , 0xEE , 0x7C , 0x38,
0x80 , 0xE0 , 0xF0 , 0xF8 , 0xFC , 0x7E , 0x3E , 0x1F,
0x1F , 0x1F , 0x3E , 0x7E , 0xFC , 0xF8 , 0x70 , 0x00
},{
0x00 , 0x00 , 0x00 , 0x01 , 0x01 , 0x00 , 0xF8 , 0xFE,
0xFF , 0xFF , 0xFF , 0x0F , 0x03 , 0x00 , 0x00 , 0x00,
0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00
},{
0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0xFF , 0xFF,
0xFF , 0xFF , 0xFF , 0x00 , 0x00 , 0x00 , 0x00 , 0x00,
0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00
},{
0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x1F , 0x7F,
0xFF , 0xFF , 0xFF , 0xC0 , 0x80 , 0x00 , 0x00 , 0x00,
0x00 , 0x00 , 0x00 , 0xC0 , 0xE0 , 0xE0 , 0xC0 , 0x00
},{
0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00,
0x01 , 0x03 , 0x07 , 0x0F , 0x1F , 0x1F , 0x1E , 0x1E,
0x1E , 0x1E , 0x0F , 0x0F , 0x07 , 0x03 , 0x01 , 0x00
}},
};


// Delay about 1.75 us
void Delay(int miliSec)
{
	int j,i;

	for(i=0;i<miliSec;i++)
	{
		for(j=0;j<10;j++)
		{
		  asm("nop");
		}
	}
}


// Port set
void SetBit(int bits)
{
    GPIOC->BSRR = bits;
}


// Port clear
void ClrBit(int bits)
{
    GPIOC->BRR = bits;
}


// Software realisation o SPI
void WriteSPI(unsigned char data)
{
	char i;
	ClrBit(CLK);
	Delay(1);
	for(i=0;i<8;i++)
	{
		if((data&0x80)==0x80)
			SetBit(DATA);
		else
			ClrBit(DATA);
		Delay(1);
		SetBit(CLK);
		Delay(1);
		ClrBit(CLK);
		data<<=1;
	}
}


// Pass data to controller
void LCD_WriteData(unsigned char data)
{
	ClrBit(SCE);
	SetBit(DC);
	WriteSPI(data);
	SetBit(SCE);
}


// Send command to controller
void LCD_WriteCmd(unsigned char cmd)
{
	ClrBit(SCE);
	ClrBit(DC);
	WriteSPI(cmd);
	SetBit(SCE);
}


// Set cursor position
void LCD_GotoXY ( unsigned char x, unsigned char y )
{
	LCD_WriteCmd (0x80 | x);
	LCD_WriteCmd (0x40 | y);

	cursor_row = y;
	cursor_col = x;
}

// Clear all LCD surface
void LCD_Clear ( void )
{
	int i,j;

	LCD_GotoXY (0,0);

	for(i=0; i<8; i++)
	{
		for(j=0; j<90; j++)
		{
			LCD_WriteData( 0x00 );
			if ((i < 6) && (j < 84))
				lcd_buffer[i][j] = 0x00;
		}
	}
    LCD_GotoXY (0,0);
}

// Initialise display controller
void LCD_Init(void)
{

    // Connect peripheral GPIOE to global clocking system
    RCC->APB2ENR |= RCC_APB2Periph_GPIOC;

    // GPIOC pin 4 output push-pull CLK - Stm32 ButterFly
    GPIOC->CRL |= 0x01<<(4*4);
    GPIOC->CRL &= ~(0x04<<(4*4));

    // GPIOC pin 5 output push-pull DATA - Stm32 ButterFly
    GPIOC->CRL |= 0x01<<(5*4);
    GPIOC->CRL &= ~(0x04<<(5*4));

    // GPIOC pin 6 output push-pull DC - Stm32 ButterFly
    GPIOC->CRL |= 0x01<<(6*4);
    GPIOC->CRL &= ~(0x04<<(6*4));

    // GPIOC pin 7 output push-pull RES - Stm32 ButterFly
    GPIOC->CRL |= 0x01<<(7*4);
    GPIOC->CRL &= ~(0x04<<(7*4));

    // GPIOC pin 11 output push-pull SCE - Stm32 ButterFly
    GPIOC->CRH |= 0x01<<(3*4);
    GPIOC->CRH &= ~(0x04<<(3*4));

	SetBit(RES);
	Delay(1);
	ClrBit(RES);
	Delay(1);
	SetBit(RES);
	Delay(1);

	LCD_WriteCmd(0x21); // Extended commands
	LCD_WriteCmd(0x05); // Switch to PCD8544 mode
	LCD_WriteCmd(0xC8); // Vpp setup and contrast
	LCD_WriteCmd(0x06); // Temperature correction
	LCD_WriteCmd(0x14); // Multiplex coefficient
	LCD_WriteCmd(0x20); // Unknow option
	LCD_WriteCmd(0x01); // Horizontal addressing
	LCD_WriteCmd(0x0C); // Standard mode display
	LCD_WriteCmd(0x80); // Clear row counter
	LCD_WriteCmd(0x05); // Switch controller in PCD8544 mode
	LCD_WriteCmd(0x40); // Clear column counter

	LCD_Clear();

}

void LCD_update( void )
{
	int i,j;

	LCD_GotoXY (0,0);  	// Start with (0,0) position

	for(i=0; i<7; i++)
	{
		LCD_GotoXY (0,i);
		for(j=0; j<84; j++)
			LCD_WriteData(lcd_buffer[i][j]);
	}
	LCD_GotoXY (0,0);	// Bring the XY position back to (0,0)
}

void LCD_WriteChar (unsigned char ch, unsigned char col, unsigned char row)
{
	unsigned char i, j;

	if(ch == 'o')
		ch = 10;
	else
		ch = ch & 0x0f;

	for(i=0;i<5;i++)
	{
		LCD_GotoXY (col, row+i);

		for(j=0; j<24; j++)
		{
			lcd_buffer[cursor_row][cursor_col + j] |=  number[ch][i][j];
			LCD_WriteData(lcd_buffer[cursor_row][cursor_col + j]);
		}
	}
}
